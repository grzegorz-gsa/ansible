Zakładamy na wszystkich vmkach konto automation z hasłem automation i wpisem do visudo

automation      ALL=(ALL:ALL) NOPASSWD:ALL

teraz bedąc zalogowanym na koncie automation

tworzymy:
    
    
[automation@ansible-control]$ mkdir plays
[automation@ansible-control]$ cd plays
[automation@ansible-control plays]$ cat ansible.cfg
 
[defaults]
roles_path = /home/automation/plays/roles
inventory = /home/automation/plays/inventory
forks = 10
#remote_user = automation
log_path = /home/automation/ansible.log


automation@controller1:~$ tree
.
└── plays
    ├── ansible.cfg
    └── inventory
        └── hosts

3 directories, 2 files
automation@controller1:~$ cat plays/inventory/hosts 
[redhaty]
10.4.0.100

[debiany]
10.4.0.200

Ostatnia faza - wymiana kluczy ssh

Na kontrolerze

ssh-keygen
ssh-copy-id 10.4.0.100  # node1
ssh-copy-id 10.4.0.200  # node2
   
   
   Wyciszenie warninga z wersją Pythona
   
[defaults]
interpreter_python = auto_silent
   
   
   Playbook1
   
   
cat playbook1.yml playbook2.yml 
---
- hosts: debiany
  become: yes
  tasks:
    - name: instalacja apache'a
      apt:
        name: apache2
        update-cache: yes
    - name: wystartuj apache2
      service:
        name: apache2
        state: started
---
- hosts: redhaty
  become: yes
  tasks:
    - name: instalacja apache'a
      yum:
        name: httpd
        state: latest
    - name: wystartuj apache2
      service:
        name: httpd
        state: started
        
Warunek when:
    
    ---
- hosts: all
  become: yes
  tasks:
    - name: instalacja apache'a DEB
      apt:
        name: apache2
        update-cache: yes
      when: ansible_os_family == "Debian"
    - name: wystartuj apache2
      service:
        name: apache2
        state: started
      when: ansible_os_family == "Debian"
    - name: instalacja apache'a RH
      yum:
        name: httpd
        state: latest
      when: ansible_os_family == "RedHat"
    - name: wystartuj apache2
      service:
        name: httpd
        state: started
      when: ansible_os_family == "RedHat"
    - name: add http site
      template:
        src: index.html.j2
        dest: /var/www/html/index.html
        mode: 0777
      
     
     
index.html.j2.

<html>
<center>
   <h1> The hostname of this webserver is {{ ansible_hostname }}</h1>
   <h3> It is running on {{ ansible_os_family}}system </h3>
</center>
</html>
      
      
      
      


Zadanie nr2 - z dawnego egazminu Redhat EX300

Create a playbook /home/automation/plays/sshd.yml that runs on all inventory hosts and configures SSHD daemon as follows:
banner is set to /etc/motd # tutaj warto coś wpisać np /etc/motd.j2 a w nim
Witaj na serwerze {{ ansible_hostname }}

X11Forwarding is disabled
MaxAuthTries is set to 3

https://docs.ansible.com/ansible/latest/collections/ansible/builtin/replace_module.html#ansible-collections-ansible-builtin-replace-module



Rozw.1

- hosts: all
  become: yes
  tasks:
  - name: Stwórz banner
    template:
      src: motd.j2
      dest: /etc/motd

  - name: X11Forwarding
    replace:
      path: /etc/ssh/sshd_config
      regexp: '^X11Forwarding yes'
      replace: 'X11Forwarding no'
 
  - name: MaxAuthtries
    replace:
      path: /etc/ssh/sshd_config
      regexp: '^#MaxAuthTries 6'
      replace: 'MaxAuthTries 3'
 
  - name: Banner
    replace:
      path: /etc/ssh/sshd_config
      regexp: '^#Banner none'
      replace: 'Banner /etc/motd'


Rozw.2 z lineinfile

---- name: Configure SSHD daemon settings
  hosts: all
  become: yes
  tasks:
    - name: Ensure SSH banner is set to /etc/motd
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Banner'
        line: 'Banner /etc/motd'
        state: present
        backup: yes

    - name: Disable X11 forwarding
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?X11Forwarding'
        line: 'X11Forwarding no'
        state: present
        backup: yes

    - name: Set MaxAuthTries to 3
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?MaxAuthTries'
        line: 'MaxAuthTries 3'
        state: present
        backup: yes

    - name: Restart SSH service to apply changes
      service:
        name: sshd
        state: restarted
      notify: restart sshd

  handlers:
    - name: restart sshd
      service:
        name: sshd
        state: restarted
        
        
        
        Główne wartości ansible_os_family:
Linux Distributions:
RedHat - RHEL, CentOS, Fedora, Rocky Linux, AlmaLinux
Debian - Debian, Ubuntu, Linux Mint
Suse - openSUSE, SLES
Archlinux - Arch Linux, Manjaro
Gentoo - Gentoo Linux
Unix Systems:
Solaris - Oracle Solaris
BSD - FreeBSD, OpenBSD, NetBSD
Darwin - macOS
Windows:
Windows - Windows Server, Windows Desktop


https://docs.ansible.com/projects/ansible/latest/playbook_guide/playbooks_vars_facts.html


Zadanie

Stwórz raport z zarządzanych serwerów
plik zapisz w katalogu /tmp/raport na kontrolerze
Co ma zawierać?

1. Informacje o procesorze
2. o wolnej pamięci RAM
3. Wolnym miejscu na dysku
4. Wersji jądra
5. ZAinstalowanym oprogramowaniu

Plik docelowy ma zawierać datę i nazwę hosta

podpowiedź moduł fetch




- hosts: all
  become: yes
  tasks:
  - name: procek
    command: cp /proc/cpuinfo /tmp/raport
  - name: naglowek cpu
    lineinfile: 
      path: /tmp/raport
      line: '[CPU]'
      insertbefore: BOF
  - name: naglowek RAM
    lineinfile:
      path: /tmp/raport
      line: '[RAM]'
      insertafter: EOF
  - name: RAM
    lineinfile:
      path: /tmp/raport
      line: "{{ ansible_memtotal_mb }} MB RAM"
      insertafter: EOF
  - name: naglowek Wolne miejsce
    lineinfile:
      path: /tmp/raport
      line: "\n[Wolne miejsce]\n"
      insertafter: EOF
  - name: wolne miejsce 
    shell:
      cmd: df -h >> /tmp/raport
  - name: naglowek kernel
    shell:
      cmd: echo "[Wersja jadra]" >> /tmp/raport
  - name: Wersja jadra
    shell:
      cmd: uname -a | cut -f3 -d ' ' >> /tmp/raport
  - name: naglowek pakietow
    shell:
      cmd: echo "[Zainstalowane oprogramowanie]" >> /tmp/raport
  - name: pakiety redhat
    shell:
      cmd: rpm -qa >> /tmp/raport
    when: ansible_os_family == "RedHat"
  - name: pakiety debian
    shell:
      cmd: apt list --installed  >> /tmp/raport
    when: ansible_os_family == "Debian"
  - name: Pobranie pliku
    fetch:
      src: /tmp/raport
      dest: tmp/raport-{{ ansible_hostname }}-{{ ansible_date_time.date }}
      flat: yes
  - name: Czyszczenie
    file:
      path: /tmp/raport
      state: absent


Zadanie

Dodaj do harmonogramu zadań wpis aby co godzinę data była dopisywana do /var/log/time.log


---
- hosts: all
  become: yes
  gather_facts: no
 
  tasks:
 
  - name: Cron with date command as a job
    cron:
      name: "Append actual date to time.log"
      minute: "0"
      hour: "*"
      job: "/bin/date >> /var/log/time.log"

https://docs.ansible.com/projects/ansible/latest/dev_guide/debugging.html


Tagi

https://www.linuxtechi.com/how-to-use-tags-in-ansible-playbook/

Windows 11

z praktyczny „runbook” krok po kroku: jak zarządzać Windows 11 dołączonym do domeny z Ansible (najczęściej przez WinRM + Kerberos). Skupię się na ustawieniu łączności, inventory i gotowych playbookach do typowych zadań.
1) Założenia i rekomendowana architektura
Control node: Linux (lub WSL) z Ansible.

Windows 11: w domenie AD, DNS działa, czas zsynchronizowany (Kerberos tego wymaga).
Łączność: WinRM (5985 HTTP lub 5986 HTTPS). W domenie Kerberos jest rekomendowany zamiast Basic/NTLM. 
2) Przygotowanie Windows 11 (WinRM „po domenowemu”)
Najlepiej zrobić to przez GPO (a nie ręcznie na każdym hoście):
2.1 Włącz WinRM i listener
Na hoście testowym możesz szybko uruchomić:

winrm quickconfig
To tworzy podstawową konfigurację WinRM. 
W GPO zwykle ustawiasz:


Enable WinRM service


Allow WinRM listeners


Reguły firewalla na 5985/5986
2.2 Uwierzytelnianie i szyfrowanie

W domenie trzymaj się Kerberos (lub Negotiate); Ansible opisuje to jako zalecaną opcję w AD. 


Jeśli używasz HTTP (5985), dopilnuj message encryption (Ansible/WinRM potrafi to robić przy kerberos/ntlm/credssp). 


Produkcyjnie rozważ WinRM po HTTPS (5986) z certyfikatem (częsty hardening), zamiast luzowania ustawień. 
3) Przygotowanie control node (Ansible)3.1 Zainstaluj kolekcje

ansible-galaxy collection install ansible.windows
ansible-galaxy collection install microsoft.ad# opcjonalnie:
ansible-galaxy collection install chocolatey.chocolatey
win_updates i większość modułów Windows jest w ansible.windows. 
Moduł do członkostwa domenowego został przeniesiony do microsoft.ad.membership. 

3.2 Kerberos na control node
Skonfiguruj Kerberos (pakiety zależą od dystrybucji), a potem:

kinit adminuser@TWOJ.REALM
klist
Ansible opisuje użycie Kerberosa i biletów jako standardowy flow. 

4) Inventory dla Windows 11 w domenie (WinRM + Kerberos)
Przykład inventory.ini:

[win11]
pc01.ad.twojefirma.local
pc02.ad.twojefirma.local
[win11:vars]ansible_connection=ansible.builtin.winrmansible_winrm_transport=kerberosansible_port=5985ansible_winrm_scheme=http
ansible_user=adminuser@AD.TWOJEFIRMA.LOCAL# hasła NIE dawaj w pliku – użyj Ansible Vault albo Kerberos (kinit)
# Dobre praktyki:ansible_winrm_message_encryption=autoansible_winrm_server_cert_validation=ignore  # tylko jeśli https + self-signed (lepiej użyć prawidłowego CA)
Dlaczego tak:


Ansible wprost rekomenduje Kerberos w domenie. 


message_encryption: auto jest wskazane przy HTTP dla bezpieczniejszej komunikacji (gdy transport to kerberos/ntlm/credssp). 

Tip: jeśli łączysz się po IP, a autoryzujesz po nazwie DNS (Kerberos), w PSRP jest opcja override nazwy; przy WinRM zwykle i tak trzymaj się FQDN. (PSRP to alternatywny transport, czasem wygodniejszy w nowych środowiskach.) 

5) Szybki test połączenia

ansible -i inventory.ini win11 -m ansible.windows.win_ping

6) Playbooki „codzienne” dla domenowych Windows 11

6.1 Lokalni administratorzy = grupa domenowa (najczęstszy use-case)

- name: Dodaj domenową grupę do lokalnych Administratorów
  hosts: win11
  gather_facts: false
  tasks:
    - name: Add AD group to local Administrators
      ansible.windows.win_group_membership:
        name: Administrators
        members:
          - "TWOJEFIRMA\\IT-Admins"
        state: present
(win_group_membership zarządza lokalnymi grupami; domenowych członków podajesz jako DOMAIN\\name). 

6.2 Windows Update (kontrolowane instalacje + reboot)

- name: Aktualizacje Windows
  hosts: win11
  gather_facts: false
  tasks:
    - name: Install critical and security updates
      ansible.windows.win_updates:
        category_names:
          - CriticalUpdates
          - SecurityUpdates
        reboot: yes
win_updates to standardowy moduł do pobierania i instalowania aktualizacji. 

6.3 Instalacja oprogramowania (MSI/EXE) albo Chocolatey
Wbudowanie instalatora:

- name: Zainstaluj MSI
  hosts: win11
  tasks:
    - name: Install 7zip MSI
      ansible.windows.win_package:
        path: C:\Installers\7z.msi
        state: present
win_package instaluje/usuwa pakiety. 
Chocolatey (jeśli używasz w organizacji):

- name: Instalacje przez Chocolatey
  hosts: win11
  tasks:
    - name: Install git
      chocolatey.chocolatey.win_chocolatey:
        name: git
        state: present

6.4 Wymuszanie ustawień „GPO-friendly” (rejestr/usługi)
Rejestr:

- name: Ustawienia w rejestrze
  hosts: win11
  tasks:
    - name: Example registry setting
      ansible.windows.win_regedit:
        path: HKLM:\Software\MyCompany
        name: ExampleFlag
        data: 1
        type: dword

Usługi:

- name: Usługi
  hosts: win11
  tasks:
    - name: Ensure Windows Update service is running
      ansible.windows.win_service:
        name: wuauserv
        state: started
        start_mode: auto
        
7) Operacje stricte domenowe (członkostwo/obiekty AD)
Jeśli chcesz zarządzać członkostwem domeny (np. upewnić się, że host jest w dobrej domenie/OU), używaj microsoft.ad.membership, bo stary win_domain_membership został usunięty z ansible.windows. 
Przykładowy szkic (często robiony „idempotentnie”):

- name: Ensure domain membership
  hosts: win11
  gather_facts: false
  tasks:
    - name: Ensure machine is domain joined
      microsoft.ad.membership:
        dns_domain_name: ad.twojefirma.local
        state: domain
        # opcje OU/credentials zależą od Twojego scenariusza
        reboot: true
Dokumentacja opisuje to jako następcę win_domain_membership. 
Jeśli Twoim celem jest tworzenie/uprzątanie obiektów komputerów w AD, rozważ też moduły typu community.windows.win_domain_computer (to już operacje na AD, nie na samym hoście). 
8) Bezpieczeństwo i praktyka operacyjna (ważne)
Nie trzymaj haseł w plaintext w inventory — użyj Kerberos (kinit) albo Ansible Vault.
Preferuj Kerberos w domenie. 
Produkcyjnie celuj w WinRM over HTTPS i sensowny hardening (certyfikaty, ograniczenie zakresu, firewall). 
Unikaj ustawiania WinRM „AllowUnencrypted=true” poza diagnostyką; Ansible wskazuje to jako opcję tylko do troubleshooting. 


